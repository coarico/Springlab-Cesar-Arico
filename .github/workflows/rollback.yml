<<<<<<< HEAD
name: Rollback to last successful deploy

on:
  workflow_dispatch:
  repository_dispatch:
    types: [rollback_requested]
=======
name: Rollback to Last Successful Deploy

on:
  workflow_dispatch:  # Permite ejecución manual
  repository_dispatch:
    types: [rollback_requested]  # Se dispara desde el CI en caso de fallo
>>>>>>> 4523962e9bea6b3ab1fa6c565b64b7f7be31051a

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Get last successful deploy
        id: last_deploy
        run: |
<<<<<<< HEAD
          RESPONSE=$(curl -s -X GET "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?status=done&limit=1" \
            -H "accept: application/json" \
            -H "authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          DEPLOY_ID=$(echo $RESPONSE | jq -r '.[0].id')
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT

      - name: Rollback to last successful deploy
        run: |
          curl -X POST \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys/${{ steps.last_deploy.outputs.deploy_id }}/retry" \
=======
          RESPONSE=$(curl -s -X GET "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?status=done&limit=10" \
            -H "accept: application/json" \
            -H "authorization: Bearer ${{ secrets.RENDER_API_KEY }}")
          
          # Buscar el último despliegue exitoso
          DEPLOY_ID=$(echo "$RESPONSE" | jq -r '.[] | select(.status == "live") | .id' | head -n 1)
          echo "Deploying version: $DEPLOY_ID"
          echo "deploy_id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          
      - name: Trigger rollback
        if: steps.last_deploy.outputs.deploy_id != ''
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys/${{ steps.last_deploy.outputs.deploy_id }}/retry" \
>>>>>>> 4523962e9bea6b3ab1fa6c565b64b7f7be31051a
            -H "accept: application/json" \
            -H "authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
